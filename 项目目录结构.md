# 项目模版 - 模块化目录结构

## 设计原则

- 按**业务模块**组织，不按技术层平铺
- 一个模块目录 = 该模块的 Config + Service + GUI + Debug 全部内容
- 地基层（foundation）放公共基础设施，不含业务逻辑
- 资源文件（YAML）跟随模块归属，不单独按类型堆放

---

## 源码目录结构

```
src/main/kotlin/com/example/project/
│
├── CobbleVoyage.kt                    # 插件主类（入口）
├── CobbleVoyageAPI.kt                 # 公共 API 门面
│
│  ══════════════════════════════════
│  地基层 (foundation/)
│  公共基础设施，不含业务逻辑
│  ══════════════════════════════════
│
├── foundation/
│   │
│   ├── model/                          # 全局数据模型（所有模块共享）
│   │   ├── Enums.kt                    #   所有枚举定义
│   │   ├── Player.kt                   #   PlayerVoyageData, VoyageStatistics
│   │   ├── Ship.kt                     #   ShipTemplate, PlayerShip
│   │   ├── Area.kt                     #   SeaArea
│   │   ├── Voyage.kt                   #   Voyage, VoyageConfigSession
│   │   ├── Pokemon.kt                  #   PokemonSnapshot, VoyageTeam
│   │   ├── Item.kt                     #   ItemTemplate, EquippedItemSnapshot
│   │   ├── Adventure.kt               #   AdventureResult, AdventureEntry
│   │   ├── Reward.kt                   #   RewardConfig, LootEntry
│   │   ├── Inbox.kt                    #   InboxMessage
│   │   ├── Memento.kt                  #   CollectedMemento
│   │   ├── Shop.kt                     #   ShopItem, ShopItemType
│   │   ├── Story.kt                    #   StoryOutput
│   │   └── Progression.kt             #   Milestone
│   │
│   ├── database/                       # 数据库基础设施
│   │   ├── IDatabase.kt                #   数据库统一接口
│   │   ├── DatabaseFactory.kt          #   工厂：根据配置创建实例
│   │   ├── DatabaseManager.kt          #   生命周期管理（初始化/关闭）
│   │   ├── DatabaseType.kt             #   枚举：SQLITE, MYSQL
│   │   └── impl/
│   │       ├── DatabaseSQLite.kt
│   │       └── DatabaseMySQL.kt
│   │
│   ├── config/                         # 全局公共配置（跨模块共享）
│   │   └── MainConfig.kt              #   数据库连接、插件通用设置
│   │
│   ├── gui/                            # GUI 基础设施
│   │   ├── GuiNavigator.kt            #   栈式导航管理器
│   │   └── GuiConfigManager.kt        #   GUI 布局加载器
│   │
│   ├── event/                          # 公共事件基类（如果有）
│   │   └── MilestoneUnlockEvent.kt    #   里程碑解锁事件（解耦 Player↔Ship）
│   │
│   └── listener/                       # 全局生命周期监听
│       └── BukkitEventListener.kt     #   PlayerJoin/Quit 分发
│
│  ══════════════════════════════════
│  API 接口层 (api/)
│  所有模块的服务契约，Phase 0 产出
│  ══════════════════════════════════
│
├── api/
│   ├── VoyageService.kt
│   ├── ShipService.kt
│   ├── AreaService.kt
│   ├── TeamService.kt
│   ├── ShopService.kt
│   ├── InboxService.kt
│   ├── MementoService.kt
│   ├── PlayerService.kt
│   └── GuiService.kt
│
│  ══════════════════════════════════
│  L1 业务模块 (modules/)
│  每个模块目录 = 完整垂直切片
│  ══════════════════════════════════
│
├── modules/
│   │
│   ├── player/                         # L1 玩家模块
│   │   ├── config/
│   │   │   └── ProgressionConfig.kt   #   里程碑 + 燃料升级配置加载
│   │   ├── service/
│   │   │   ├── PlayerManager.kt       #   玩家数据缓存、声望/货币/经验管理
│   │   │   ├── PlayerServiceImpl.kt   #   实现 api/PlayerService
│   │   │   └── PlayerRepository.kt    #   cb_voyage_players, cb_voyage_statistics
│   │   ├── gui/
│   │   │   ├── PlayerInfoGui.kt
│   │   │   └── MilestoneGui.kt
│   │   └── debug/
│   │       └── PlayerDebugProvider.kt #   向 DebugService 暴露玩家诊断数据
│   │
│   ├── ship/                           # L1 船只模块
│   │   ├── config/
│   │   │   └── ShipConfig.kt          #   船只模板加载
│   │   ├── service/
│   │   │   ├── ShipManager.kt         #   船只属性计算（纯函数）
│   │   │   ├── ShipServiceImpl.kt     #   实现 api/ShipService
│   │   │   └── ShipRepository.kt      #   cb_voyage_ships
│   │   ├── gui/
│   │   │   ├── ShipSelectGui.kt
│   │   │   ├── ShipManageGui.kt
│   │   │   └── ShipDetailGui.kt
│   │   ├── event/
│   │   │   ├── ShipRepairEvent.kt
│   │   │   ├── ShipUpgradeEvent.kt
│   │   │   └── ShipEnhanceEvent.kt
│   │   └── debug/
│   │       └── ShipDebugProvider.kt
│   │
│   ├── area/                           # L1 海域模块
│   │   ├── config/
│   │   │   └── AreaConfig.kt
│   │   ├── service/
│   │   │   ├── AreaManager.kt
│   │   │   └── AreaServiceImpl.kt     #   实现 api/AreaService
│   │   ├── gui/
│   │   │   ├── AreaSelectGui.kt
│   │   │   ├── AreaListGui.kt
│   │   │   └── AreaDetailGui.kt
│   │   └── debug/
│   │       └── AreaDebugProvider.kt
│   │
│   ├── team/                           # L1 宝可梦队伍模块
│   │   ├── config/
│   │   │   ├── TypeBonusConfigLoader.kt
│   │   │   ├── BondConfigLoader.kt
│   │   │   ├── SpeciesNameMapper.kt
│   │   │   └── TypeNameMapper.kt
│   │   ├── service/
│   │   │   ├── TeamManager.kt         #   队伍构建 + 加成计算
│   │   │   └── TeamServiceImpl.kt     #   实现 api/TeamService
│   │   ├── gui/
│   │   │   └── PokemonSelectGui.kt
│   │   └── debug/
│   │       └── TeamDebugProvider.kt
│   │
│   ├── item/                           # L1 物品模块
│   │   ├── config/
│   │   │   └── ItemConfigLoader.kt    #   装备 + 货物模板
│   │   ├── gui/
│   │   │   ├── BackpackGui.kt
│   │   │   └── EquipSelectGui.kt
│   │   └── debug/
│   │       └── ItemDebugProvider.kt
│   │
│   │  ─────────────────────────────
│   │  L2 综合模块
│   │  ─────────────────────────────
│   │
│   ├── adventure/                      # L2 冒险结算模块
│   │   ├── config/
│   │   │   ├── WeatherConfig.kt
│   │   │   ├── EncounterConfig.kt
│   │   │   ├── EventConfig.kt
│   │   │   └── RewardConfigLoader.kt
│   │   ├── engine/
│   │   │   ├── AdventureEngine.kt     #   核心结算算法
│   │   │   └── LootResolver.kt        #   战利品解算
│   │   └── debug/
│   │       └── AdventureDebugProvider.kt
│   │
│   ├── story/                          # L2 故事引擎模块
│   │   ├── config/
│   │   │   └── StoryConfig.kt         #   AI 设置（从 MainConfig 拆出）
│   │   ├── engine/
│   │   │   └── StoryGenerator.kt      #   模板 + LLM 双模式
│   │   └── debug/
│   │       └── StoryDebugProvider.kt  #   含 testConnection()
│   │
│   ├── shop/                           # L2 商店模块
│   │   ├── config/
│   │   │   └── ShopConfigLoader.kt
│   │   ├── service/
│   │   │   ├── ShopManager.kt
│   │   │   └── ShopServiceImpl.kt     #   实现 api/ShopService
│   │   ├── function/                   #   EasyLib Matcher/Action（本模块专属）
│   │   │   ├── VoyageFunctionRegistry.kt
│   │   │   ├── ReputationMatcher.kt
│   │   │   ├── CurrencyMatcher.kt
│   │   │   ├── LevelMatcher.kt
│   │   │   ├── ReputationAction.kt
│   │   │   └── CurrencyAction.kt
│   │   ├── gui/
│   │   │   └── ShopGui.kt
│   │   ├── event/
│   │   │   └── ItemPurchaseEvent.kt
│   │   └── debug/
│   │       └── ShopDebugProvider.kt
│   │
│   ├── inbox/                          # L2 邮箱模块
│   │   ├── service/
│   │   │   ├── InboxManager.kt
│   │   │   ├── InboxServiceImpl.kt    #   实现 api/InboxService
│   │   │   └── InboxRepository.kt     #   cb_voyage_inbox
│   │   ├── gui/
│   │   │   ├── InboxGui.kt
│   │   │   └── MailDetailGui.kt
│   │   ├── event/
│   │   │   └── AttachmentClaimEvent.kt
│   │   └── debug/
│   │       └── InboxDebugProvider.kt
│   │
│   ├── memento/                        # L2 纪念物模块
│   │   ├── config/
│   │   │   └── MementoConfigLoader.kt
│   │   ├── service/
│   │   │   ├── MementoManager.kt
│   │   │   ├── MementoServiceImpl.kt  #   实现 api/MementoService
│   │   │   └── MementoRepository.kt   #   cb_voyage_mementos
│   │   ├── gui/
│   │   │   ├── MementoGui.kt
│   │   │   └── MementoDetailGui.kt
│   │   └── debug/
│   │       └── MementoDebugProvider.kt
│   │
│   └── voyage/                         # L2 航海编排模块
│       ├── service/
│       │   ├── VoyageManager.kt       #   生命周期调度（30s 周期检查）
│       │   ├── VoyageServiceImpl.kt   #   实现 api/VoyageService
│       │   └── VoyageRepository.kt    #   cb_voyage_voyages
│       ├── gui/
│       │   ├── MainMenuGui.kt
│       │   ├── VoyageConfigGui.kt
│       │   ├── VoyageStatusGui.kt
│       │   └── VoyageHistoryGui.kt
│       ├── event/
│       │   ├── VoyageStartEvent.kt
│       │   ├── VoyageEndEvent.kt
│       │   └── VoyageCancelEvent.kt
│       ├── command/
│       │   ├── VoyageCommand.kt       #   /voyage 主命令
│       │   └── AdminCommand.kt        #   管理员命令
│       └── debug/
│           └── VoyageDebugProvider.kt
│
│  ══════════════════════════════════
│  L3 边缘模块
│  ══════════════════════════════════
│
├── peripheral/
│   │
│   ├── debug/                          # L3 调试模块（聚合所有 DebugProvider）
│   │   ├── DebugConfigLoader.kt
│   │   ├── DebugService.kt           #   聚合各模块的 DebugProvider
│   │   └── DebugCommands.kt          #   /cvdebug 命令
│   │
│   └── placeholder/                    # L3 占位符
│       └── CobbleVoyagePlaceholder.kt
│
└── integration/                        # GuiService 聚合入口
    └── GuiServiceImpl.kt             #   实现 api/GuiService，分发到各模块 GUI
```

## 资源目录结构

资源文件跟随模块归属，不按类型堆放。每个模块的 YAML 配置、GUI 布局都放在该模块的资源子目录下。

```
src/main/resources/
│
├── config.yml                             # 全局主配置（数据库、通用设置）
├── lang/
│   └── zh_CN.yml                          # 语言文件
│
│  ══════════════════════════════════
│  地基层资源
│  ══════════════════════════════════
│
├── foundation/
│   ├── debug.yml                          # Debug 开关 + step 级别控制
│   └── gui/                               # GUI 基础设施的公共模板（如有）
│
│  ══════════════════════════════════
│  模块资源（每个模块一个目录）
│  ══════════════════════════════════
│
├── modules/
│   │
│   ├── player/
│   │   ├── progression/
│   │   │   └── 里程碑.yml                #   里程碑 + 燃料升级
│   │   └── gui/
│   │       ├── player_info.yml
│   │       └── milestone.yml
│   │
│   ├── ship/
│   │   ├── templates/                     #   船只模板定义
│   │   │   ├── 普通帆船.yml
│   │   │   ├── 快速帆船.yml
│   │   │   ├── 大帆船.yml
│   │   │   ├── 战舰.yml
│   │   │   └── 幽灵船.yml
│   │   └── gui/
│   │       ├── ship_select.yml
│   │       ├── ship_manage.yml
│   │       └── ship_detail.yml
│   │
│   ├── area/
│   │   ├── definitions/                   #   海域定义
│   │   │   ├── 宁静海湾.yml
│   │   │   ├── 珊瑚礁.yml
│   │   │   ├── 风暴海峡.yml
│   │   │   └── 深渊海沟.yml
│   │   └── gui/
│   │       ├── area_select.yml
│   │       ├── area_list.yml
│   │       └── area_detail.yml
│   │
│   ├── team/
│   │   ├── type_bonus.yml                 #   属性加成配置
│   │   ├── bonds.yml                      #   羁绊配置
│   │   ├── species_names.yml              #   宝可梦中文名映射
│   │   ├── type_names.yml                 #   属性中文名映射
│   │   └── gui/
│   │       └── pokemon_select.yml
│   │
│   ├── item/
│   │   ├── equipment.yml                  #   装备模板
│   │   ├── cargo.yml                      #   货物模板
│   │   └── gui/
│   │       ├── backpack.yml
│   │       └── equip_select.yml
│   │
│   ├── adventure/
│   │   ├── weather/
│   │   │   └── 天气配置.yml
│   │   ├── encounters/
│   │   │   └── 遭遇配置.yml
│   │   ├── events/                        #   每个海域的事件池
│   │   │   ├── 宁静海湾.yml
│   │   │   ├── 珊瑚礁.yml
│   │   │   ├── 风暴海峡.yml
│   │   │   └── 深渊海沟.yml
│   │   └── rewards/                       #   奖励池
│   │       ├── 默认奖励.yml
│   │       └── 宁静海湾.yml
│   │
│   ├── story/
│   │   └── templates/
│   │       └── 故事模板.yml
│   │
│   ├── shop/
│   │   ├── definitions/                   #   商店定义
│   │   │   ├── 通用商店.yml
│   │   │   ├── 稀有商店.yml
│   │   │   └── 船只商店.yml
│   │   └── gui/
│   │       └── shop.yml
│   │
│   ├── inbox/
│   │   └── gui/
│   │       ├── inbox.yml
│   │       └── mail_detail.yml
│   │
│   ├── memento/
│   │   ├── definitions/
│   │   │   └── 纪念物.yml
│   │   └── gui/
│   │       ├── memento.yml
│   │       └── memento_detail.yml
│   │
│   └── voyage/
│       └── gui/
│           ├── main_menu.yml
│           ├── voyage_config.yml
│           ├── voyage_status.yml
│           └── voyage_history.yml
```

---

## 新旧路径对照表

| 旧路径（按类型平铺） | 新路径（按模块归属） | 所属模块 |
|----------------------|---------------------|---------|
| `config.yml` | `config.yml` | 地基（不变） |
| `debug.yml` | `foundation/debug.yml` | 地基 |
| `lang/zh_CN.yml` | `lang/zh_CN.yml` | 地基（不变） |
| `ships/*.yml` | `modules/ship/templates/*.yml` | Ship |
| `areas/*.yml` | `modules/area/definitions/*.yml` | Area |
| `events/*.yml` | `modules/adventure/events/*.yml` | Adventure |
| `rewards/*.yml` | `modules/adventure/rewards/*.yml` | Adventure |
| `weather/天气配置.yml` | `modules/adventure/weather/天气配置.yml` | Adventure |
| `encounters/遭遇配置.yml` | `modules/adventure/encounters/遭遇配置.yml` | Adventure |
| `items/equipment.yml` | `modules/item/equipment.yml` | Item |
| `items/cargo.yml` | `modules/item/cargo.yml` | Item |
| `shops/*.yml` | `modules/shop/definitions/*.yml` | Shop |
| `mementos/纪念物.yml` | `modules/memento/definitions/纪念物.yml` | Memento |
| `progression/里程碑.yml` | `modules/player/progression/里程碑.yml` | Player |
| `bonds.yml` | `modules/team/bonds.yml` | Team |
| `type_bonus.yml` | `modules/team/type_bonus.yml` | Team |
| `species_names.yml` | `modules/team/species_names.yml` | Team |
| `type_names.yml` | `modules/team/type_names.yml` | Team |
| `story_templates/故事模板.yml` | `modules/story/templates/故事模板.yml` | Story |
| `gui/ship_select.yml` | `modules/ship/gui/ship_select.yml` | Ship |
| `gui/area_list.yml` | `modules/area/gui/area_list.yml` | Area |
| `gui/shop.yml` | `modules/shop/gui/shop.yml` | Shop |
| `gui/inbox.yml` | `modules/inbox/gui/inbox.yml` | Inbox |
| `gui/memento.yml` | `modules/memento/gui/memento.yml` | Memento |
| `gui/main_menu.yml` | `modules/voyage/gui/main_menu.yml` | Voyage |
| `gui/player_info.yml` | `modules/player/gui/player_info.yml` | Player |
| `gui/pokemon_select.yml` | `modules/team/gui/pokemon_select.yml` | Team |
| `gui/backpack.yml` | `modules/item/gui/backpack.yml` | Item |

---

## 设计说明

### 为什么资源也要按模块分？

旧结构中 `gui/` 下堆了 20 个布局文件，`events/` 和 `areas/` 分属不同目录但逻辑上紧密关联。
按模块分后，一个 Agent 实现 Ship 模块时，只需关注 `modules/ship/` 下的源码和资源，不需要在多个顶层目录间跳转。

### 哪些文件留在顶层？

- `config.yml` — 全局主配置，所有模块共享，不属于任何单一模块
- `lang/zh_CN.yml` — 语言文件是全局的，所有模块的文本都在里面
- `foundation/debug.yml` — Debug 开关是基础设施，不属于业务模块

### Config 加载器如何适配？

每个模块的 ConfigLoader 需要更新资源路径。例如：

```kotlin
// 旧：ShipConfig 从 "ships/" 加载
val file = File(plugin.dataFolder, "ships/$fileName")

// 新：ShipConfig 从 "modules/ship/templates/" 加载
val file = File(plugin.dataFolder, "modules/ship/templates/$fileName")
```

TabooLib 的 `@Config` 注解同理，路径需要指向新位置。
